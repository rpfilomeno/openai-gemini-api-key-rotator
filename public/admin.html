<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Rotator - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
          --background: #fafafa;
          --foreground: #0a0a0a;
          --card: #ffffff;
          --card-foreground: #0a0a0a;
          --popover: #ffffff;
          --popover-foreground: #0a0a0a;
          --primary: #18181b;
          --primary-foreground: #fafafa;
          --secondary: #f4f4f5;
          --secondary-foreground: #0a0a0a;
          --muted: #f4f4f5;
          --muted-foreground: #71717a;
          --accent: #f4f4f5;
          --accent-foreground: #0a0a0a;
          --destructive: #ff2626;
          --destructive-foreground: #ffffff;
          --border: #e4e4e7;
          --input: #ffffff;
          --ring: #18181b;
          --success: #22c55e;
          --success-foreground: #ffffff;
          --warning: #f59e0b;
          --warning-foreground: #ffffff;
          --info: #3b82f6;
          --info-foreground: #ffffff;
          --radius: 0.5rem;
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
          --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
          --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .dark {
          --background: #0a0a0a;
          --foreground: #fafafa;
          --card: #18181b;
          --card-foreground: #fafafa;
          --popover: #18181b;
          --popover-foreground: #fafafa;
          --primary: #fafafa;
          --primary-foreground: #18181b;
          --secondary: #27272a;
          --secondary-foreground: #fafafa;
          --muted: #27272a;
          --muted-foreground: #a1a1aa;
          --accent: #27272a;
          --accent-foreground: #fafafa;
          --destructive: #ff2626;
          --destructive-foreground: #ffffff;
          --border: #27272a;
          --input: #18181b;
          --ring: #d4d4d8;
          --success: #22c55e;
          --success-foreground: #ffffff;
          --warning: #f59e0b;
          --warning-foreground: #ffffff;
          --info: #3b82f6;
          --info-foreground: #ffffff;
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
          --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
          --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .section {
            background-color: var(--card);
            color: var(--foreground);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .section-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .input-group {
            background-color: var(--muted);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .key-row {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .login-container {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .btn {
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background-color: var(--accent);
        }
        
        .btn-destructive {
            background-color: var(--destructive);
            color: var(--destructive-foreground);
        }
        
        .btn-destructive:hover {
            opacity: 0.9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--success-foreground);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--warning-foreground);
        }
        
        .btn-info {
            background-color: var(--info);
            color: var(--info-foreground);
        }
        
        .input-field {
            background-color: var(--input);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: var(--radius);
            font-family: inherit;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--background);
            box-shadow: 0 0 0 1px var(--primary);
        }
        
        .muted {
            color: var(--muted-foreground);
        }
        
        /* Header styles */
        .header-bg {
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
        }
        
        /* Sticky header */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
        }
        
        .sticky-nav-tabs {
            position: fixed;
            top: 72px; /* Position below main header */
            left: 0;
            right: 0;
            z-index: 99;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
        }
        
        /* Content offset for sticky header */
        .content-with-sticky-header {
            margin-top: 130px; /* Use margin instead of padding for better spacing */
        }
        
        /* Tab styles */
        .tab-btn {
            position: relative;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 2px;
            background-color: var(--primary);
            border-radius: 2px;
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: var(--muted);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--border);
        }
        
        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 16px;
            height: 16px;
            background-color: var(--foreground);
            border-radius: 50%;
            transition: transform 0.2s ease;
            border: 2px solid #000000;
        }
        
        .dark .theme-toggle::before {
            border: 2px solid #ffffff;
        }
        
        .theme-toggle.dark::before {
            transform: translateX(22px);
        }
        
        /* Animations */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        card: 'var(--card)',
                        'card-foreground': 'var(--card-foreground)',
                        primary: 'var(--primary)',
                        'primary-foreground': 'var(--primary-foreground)',
                        secondary: 'var(--secondary)',
                        'secondary-foreground': 'var(--secondary-foreground)',
                        muted: 'var(--muted)',
                        'muted-foreground': 'var(--muted-foreground)',
                        destructive: 'var(--destructive)',
                        'destructive-foreground': 'var(--destructive-foreground)',
                        border: 'var(--border)',
                        input: 'var(--input)',
                        ring: 'var(--ring)',
                    },
                    fontFamily: {
                        sans: 'var(--font-sans)',
                        mono: 'var(--font-mono)',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    },
                    boxShadow: {
                        sm: 'var(--shadow-sm)',
                        md: 'var(--shadow-md)',
                        lg: 'var(--shadow-lg)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-background" id="mainBody">
    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <div class="mx-auto h-12 w-12 flex items-center justify-center bg-primary text-primary-foreground rounded-lg mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-foreground">Admin Login</h1>
                <p class="text-muted-foreground mt-2">Enter your admin password to access the panel</p>
            </div>
            
            <div class="login-container p-6">
                <div class="space-y-4">
                    <div id="loginInputs">
                        <div>
                            <label for="password" class="block text-sm font-medium text-foreground mb-2">Password</label>
                            <input
                                type="password"
                                id="password"
                                class="input-field w-full px-3 py-2 rounded-md transition-colors"
                                placeholder="Enter admin password"
                            >
                        </div>
                        <button
                            onclick="login()"
                            id="loginButton"
                            class="btn btn-primary w-full py-3 px-4 font-medium mt-4"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                            </svg>
                            Sign In
                        </button>
                    </div>
                    <div id="rateLimitMessage" class="hidden">
                        <div class="bg-destructive/10 border border-destructive/20 text-destructive px-4 py-6 rounded-md text-center">
                            <svg class="w-12 h-12 mx-auto mb-4 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <h3 class="text-lg font-semibold mb-2">Too Many Failed Attempts</h3>
                            <p class="text-sm mb-4">Login has been temporarily blocked for security.</p>
                            <div class="text-2xl font-bold mb-2" id="countdownTimer">5:00</div>
                            <p class="text-xs text-muted-foreground">Time remaining until you can try again</p>
                        </div>
                    </div>
                    <div id="loginError" class="hidden bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Header -->
        <header class="header-bg sticky-header">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3">
                    <div class="flex items-center space-x-3">
                        <div class="h-7 w-7 bg-primary text-primary-foreground rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-foreground">API Key Rotator</h1>
                            <p class="text-xs text-muted-foreground">Admin Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Dark Mode Toggle -->
                        <div class="flex items-center space-x-1.5">
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()"></div>
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </div>
                        <button 
                            onclick="logout()" 
                            class="btn btn-destructive px-3 py-1.5 text-xs font-medium"
                        >
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div id="navigationTabs" class="header-bg border-b border-border sticky-nav-tabs">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <nav class="flex space-x-6">
                        <button 
                            onclick="showTab('environment')" 
                            class="tab-btn py-3 px-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border transition-colors active flex items-center space-x-2"
                            data-tab="environment"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1721 9z" />
                            </svg>
                            <span class="text-sm">API Keys</span>
                        </button>
                        <button 
                            onclick="showTab('logs')" 
                            class="tab-btn py-3 px-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border transition-colors flex items-center space-x-2"
                            data-tab="logs"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span class="text-sm">API Logs</span>
                        </button>
                    </nav>
                    
                    <!-- Header Notifications Area (placeholder for positioning) -->
                    <div id="headerNotifications" class="py-2 ml-6 flex-1 max-w-2xl overflow-hidden relative">
                        <!-- Placeholder for positioning calculations -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 content-with-sticky-header">
            <!-- Environment Tab -->
            <div id="environment" class="tab-content">
                <div class="section-header">
                    <h2 class="text-lg font-semibold text-foreground">API Keys Management</h2>
                    <p class="text-muted-foreground text-xs mt-1">Manage and test your API keys</p>
                </div>


                <!-- Providers Management -->
                <div class="space-y-4">
                    <!-- Existing Providers -->
                    <div class="section">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-foreground">Configured Providers</h3>
                            <button
                                onclick="exportConfiguration()"
                                class="btn btn-secondary px-3 py-1.5 text-xs font-medium flex items-center gap-1.5"
                                title="Copy all configuration as .env format to clipboard"
                            >
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy .env
                            </button>
                        </div>
                        <div id="providersContainer" class="space-y-3 mb-4"></div>
                    </div>

                    <!-- Add New Provider -->
                    <div class="section">
                        <h3 class="text-sm font-medium text-foreground mb-3">Add New Provider</h3>
                        <div class="border-dashed border border-border rounded p-4 bg-muted/30 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-muted-foreground mb-2">Provider Name</label>
                                    <input
                                        type="text"
                                        id="newProviderName"
                                        class="input-field w-full px-2 py-1.5 text-sm rounded transition-colors"
                                        placeholder="e.g., groq, together"
                                        oninput="handleProviderNameInput(this); updateProviderPreview()"
                                    >
                                    <p class="text-muted-foreground text-xs mt-1">Provide both name and base URL for custom provider</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-muted-foreground mb-2">API Type</label>
                                    <select 
                                        id="newProviderApiType" 
                                        class="input-field w-full px-2 py-1.5 text-sm rounded transition-colors"
                                        onchange="updateProviderPreview()"
                                    >
                                        <option value="openai">OpenAI Compatible</option>
                                        <option value="gemini">Gemini Compatible</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-muted-foreground mb-2">Base URL</label>
                                    <input 
                                        type="text" 
                                        id="newProviderBaseUrl" 
                                        class="input-field w-full px-2 py-1.5 text-sm rounded transition-colors" 
                                        placeholder="e.g., https://api.example.com/v1"
                                        oninput="handleBaseUrlInput(this); updateProviderPreview()"
                                    >
                                    <p class="text-muted-foreground text-xs mt-1">Provide both name and base URL for custom provider</p>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-muted-foreground mb-2">API Keys</label>
                                <div id="newProviderKeys" class="space-y-2">
                                    <div class="flex items-center space-x-2" data-key-index="0">
                                        <input 
                                            type="text" 
                                            class="input-field flex-1 px-2 py-1.5 text-xs rounded transition-colors new-provider-key" 
                                            placeholder="Enter API key"
                                            data-key-index="0"
                                        >
                                        <button 
                                            onclick="testNewProviderKey(0)" 
                                            class="btn btn-secondary px-2 py-1 text-xs font-medium"
                                        >
                                            Test
                                        </button>
                                        <button 
                                            onclick="removeNewProviderKey(0)" 
                                            class="btn btn-destructive px-2 py-1 text-xs font-medium"
                                            style="display: none;"
                                        >
                                            Remove
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 mt-2">
                                    <button 
                                        onclick="addNewProviderKey()" 
                                        class="btn btn-secondary px-3 py-1.5 text-xs font-medium"
                                    >
                                        + Add Another Key
                                    </button>
                                    <button 
                                        onclick="addNewProvider()" 
                                        class="btn btn-primary px-3 py-1.5 text-xs font-medium"
                                    >
                                        Test & Save Provider
                                    </button>
                                </div>
                                <p class="text-muted-foreground text-xs mt-1">Add multiple API keys for automatic rotation. All keys will be tested before saving.</p>
                            </div>
                            <div id="newProviderPreview" class="mt-3 p-3 bg-muted/20 border border-border rounded text-xs text-muted-foreground">
                                <strong>Preview:</strong> <span id="previewText">Will create default OpenAI provider</span>
                            </div>
                            <div id="newProviderResult" class="mt-2"></div>
                        </div>
                    </div>

                </div>

                <!-- Status Messages -->
                <div id="envSuccess" class="hidden bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-md mt-4"></div>
                <div id="envError" class="hidden bg-destructive/10 border border-destructive/20 text-destructive px-4 py-3 rounded-md mt-4"></div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content hidden">
                <div class="section-header">
                    <h2 class="text-lg font-semibold text-foreground">API Request Logs</h2>
                    <p class="text-muted-foreground text-xs mt-1">Monitor OpenAI and Gemini API requests and responses</p>
                </div>

                <div class="space-y-4">

                    <!-- Logs Display -->
                    <div class="section">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-foreground">Recent API Requests</h3>
                            <button onclick="handleRefreshLogs(this)" class="btn btn-secondary px-3 py-1.5 text-xs font-medium flex items-center gap-1.5" title="Refresh logs">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Reload
                            </button>
                        </div>
                        <p class="text-xs text-muted-foreground mb-3">Last 100 entries kept in memory â€¢ Lost on server restart</p>
                        <div class="bg-gray-900 border border-border rounded">
                            <div id="logsContainer" class="text-green-400 p-3 font-mono text-xs h-80 overflow-y-auto whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 py-6 border-t border-border">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-center text-sm text-muted-foreground">
                    <a href="https://github.com/p32929/openai-gemini-api-key-rotator" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">
                        Star & Fork on GitHub
                    </a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Single Notification Overlay -->
    <div id="singleNotification" class="fixed bg-card border border-border rounded-md shadow-lg z-[150] transition-all duration-300 hidden" style="top: 140px; right: 20px; min-width: 400px; max-width: 600px;">
        <div class="flex items-center space-x-3 px-4 py-3">
            <div id="singleIcon" class="flex-shrink-0"></div>
            <span id="singleMessage" class="flex-1 text-sm text-foreground"></span>
            <span id="notificationCount" class="flex-shrink-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium hidden">+2</span>
            <button onclick="clearCurrentNotification()" class="flex-shrink-0 text-muted-foreground hover:text-foreground transition-colors p-1" title="Dismiss">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Expanded Notifications Overlay -->
    <div id="expandedNotifications" class="fixed bg-card border border-border rounded-md shadow-xl z-[200] min-w-96 max-w-2xl hidden" style="top: 140px; right: 20px;">
        <div class="max-h-80 overflow-y-auto">
            <div id="allNotificationsList" class="space-y-1 p-3">
                <!-- Notifications will be populated here -->
            </div>
        </div>
        <div class="border-t border-border p-3 flex justify-between items-center">
            <span class="text-xs text-muted-foreground" id="queueStatus">All notifications</span>
            <button onclick="clearAllNotifications()" class="btn btn-secondary px-2 py-1 text-xs">
                Clear All
            </button>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[110]">
        <div class="bg-card border border-border rounded-lg p-6 max-w-md w-full shadow-xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="h-10 w-10 bg-destructive/10 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-foreground">Delete API Key</h3>
                    <p class="text-sm text-muted-foreground">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-foreground mb-6" id="confirmMessage">Are you sure you want to delete this API key?</p>
            <div class="flex justify-end space-x-3">
                <button 
                    onclick="cancelDelete()" 
                    class="btn btn-secondary px-4 py-2 text-sm font-medium"
                >
                    Cancel
                </button>
                <button 
                    onclick="confirmDelete()" 
                    class="btn btn-destructive px-4 py-2 text-sm font-medium"
                >
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Response Viewer Dialog -->
    <div id="responseDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[110]">
        <div class="bg-card border border-border rounded-lg p-6 max-w-4xl w-full h-[80vh] flex flex-col shadow-xl">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <div>
                    <h3 class="text-lg font-semibold text-foreground">API Response</h3>
                    <p class="text-sm text-muted-foreground" id="responseInfo">Loading...</p>
                </div>
                <button 
                    onclick="closeResponseDialog()" 
                    class="text-muted-foreground hover:text-foreground transition-colors p-1"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Tabs for Request/Response -->
            <div class="flex space-x-4 mb-4 flex-shrink-0" id="requestResponseTabs">
                <button 
                    id="responseTab"
                    onclick="switchResponseTab('response')" 
                    class="px-4 py-2 rounded-md text-sm font-medium btn-primary"
                >
                    Response
                </button>
                <button 
                    id="requestTab"
                    onclick="switchResponseTab('request')" 
                    class="px-4 py-2 rounded-md text-sm font-medium btn-secondary hidden disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Request Body
                </button>
            </div>
            
            <div class="flex-1 min-h-0">
                <pre id="responseContent" class="bg-gray-900 text-green-400 p-4 rounded-md text-sm h-full overflow-auto font-mono whitespace-pre-wrap border"></pre>
                <pre id="requestContent" class="bg-gray-900 text-yellow-400 p-4 rounded-md text-sm h-full overflow-auto font-mono whitespace-pre-wrap border hidden"></pre>
            </div>
        </div>
    </div>



    <script>
        let envVars = {};

        // Unified copy to clipboard function that works without SSL
        async function copyToClipboard(text, successMessage) {
            try {
                // Try modern clipboard API first
                await navigator.clipboard.writeText(text);
                showSuccessToast(successMessage || 'Copied to clipboard!');
                return true;
            } catch (error) {
                // Fallback for non-HTTPS or older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) {
                        showSuccessToast(successMessage || 'Copied to clipboard!');
                        return true;
                    } else {
                        showErrorToast('Failed to copy to clipboard');
                        return false;
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    showErrorToast('Failed to copy to clipboard');
                    return false;
                }
            }
        }

        // Header-integrated notification system
        let activeNotifications = [];
        let notificationId = 0;
        const MAX_NOTIFICATIONS = 20;
        let notificationTimeouts = new Map();
        
        function showToast(message, type = 'info', duration = 4000) {
            const timestamp = new Date();
            const id = ++notificationId;
            
            // Define notification styles and icons based on type
            let bgColor, textColor, iconSvg;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800';
                    textColor = 'text-green-800 dark:text-green-200';
                    iconSvg = `<svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                    break;
                case 'error':
                    bgColor = 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800';
                    textColor = 'text-red-800 dark:text-red-200';
                    iconSvg = `<svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800';
                    textColor = 'text-yellow-800 dark:text-yellow-200';
                    iconSvg = `<svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>`;
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800';
                    textColor = 'text-blue-800 dark:text-blue-200';
                    iconSvg = `<svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                    break;
            }
            
            // Create notification object
            const notification = {
                id: id,
                message: message,
                type: type,
                timestamp: timestamp,
                bgColor: bgColor,
                textColor: textColor,
                iconSvg: iconSvg,
                duration: duration
            };
            
            // Add to active notifications
            activeNotifications.push(notification);
            
            // Limit notifications
            if (activeNotifications.length > MAX_NOTIFICATIONS) {
                // Remove oldest notification
                const oldestId = activeNotifications.shift().id;
                hideNotification(oldestId);
            }
            
            // Show immediately
            updateNotificationDisplay();
            
            // Auto-hide after duration
            if (duration > 0) {
                const timeout = setTimeout(() => {
                    hideNotification(id);
                }, duration);
                notificationTimeouts.set(id, timeout);
            }
            
            return id;
        }
        
        function updateNotificationDisplay() {
            // Show single notification or count
            const singleNotification = document.getElementById('singleNotification');
            const singleIcon = document.getElementById('singleIcon');
            const singleMessage = document.getElementById('singleMessage');
            const notificationCount = document.getElementById('notificationCount');
            
            if (activeNotifications.length === 0) {
                singleNotification.classList.add('hidden');
                return;
            }
            
            // Show the latest notification
            const latest = activeNotifications[activeNotifications.length - 1];
            singleIcon.innerHTML = latest.iconSvg;
            singleMessage.textContent = latest.message;
            
            // Apply styles
            const container = singleNotification.querySelector('div');
            container.className = `flex items-center space-x-3 px-4 py-3 ${latest.bgColor} ${latest.textColor}`;
            
            // Show count if there are multiple
            if (activeNotifications.length > 1) {
                notificationCount.textContent = `+${activeNotifications.length - 1}`;
                notificationCount.classList.remove('hidden');
            } else {
                notificationCount.classList.add('hidden');
            }
            
            // Position and show
            positionNotifications();
            singleNotification.classList.remove('hidden');
            
            // Update expanded view
            updateExpandedNotifications();
        }
        
        function hideNotification(id) {
            // Remove from active notifications
            activeNotifications = activeNotifications.filter(n => n.id !== id);
            
            // Clear timeout
            if (notificationTimeouts.has(id)) {
                clearTimeout(notificationTimeouts.get(id));
                notificationTimeouts.delete(id);
            }
            
            // Update display
            updateNotificationDisplay();
        }
        
        function positionNotifications() {
            // Notifications are now fixed positioned relative to the sticky header
            // They stay in the same spot in the viewport regardless of scroll
            const singleNotification = document.getElementById('singleNotification');
            const expandedNotifications = document.getElementById('expandedNotifications');
            
            if (!singleNotification || !expandedNotifications) return;
            
            // Fixed position below the sticky header (header ~72px + nav ~68px = ~140px)
            const topPosition = '140px';
            const rightPosition = '20px';
            
            singleNotification.style.top = topPosition;
            singleNotification.style.right = rightPosition;
            
            expandedNotifications.style.top = topPosition;
            expandedNotifications.style.right = rightPosition;
        }
        

        
        function updateExpandedNotifications() {
            const allNotificationsList = document.getElementById('allNotificationsList');
            const queueStatus = document.getElementById('queueStatus');
            
            if (!allNotificationsList) return;
            
            // Clear existing content
            allNotificationsList.innerHTML = '';
            
            // Add all active notifications (newest first)
            const reversedNotifications = [...activeNotifications].reverse();
            reversedNotifications.forEach((notification, index) => {
                const div = document.createElement('div');
                div.className = `flex items-center space-x-3 text-sm px-3 py-2 rounded border ${notification.bgColor} ${notification.textColor}`;
                
                // Add dismiss button for each notification
                div.innerHTML = `
                    ${notification.iconSvg}
                    <span class="flex-1">${notification.message}</span>
                    <span class="text-xs opacity-75">${new Date(notification.timestamp).toLocaleTimeString()}</span>
                    <button onclick="hideNotification(${notification.id})" class="flex-shrink-0 text-muted-foreground hover:text-foreground transition-colors p-1" title="Dismiss">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                allNotificationsList.appendChild(div);
            });
            
            // Update status
            if (queueStatus) {
                if (activeNotifications.length === 0) {
                    queueStatus.textContent = 'No notifications';
                } else if (activeNotifications.length === 1) {
                    queueStatus.textContent = '1 active notification';
                } else {
                    queueStatus.textContent = `${activeNotifications.length} active notifications`;
                }
            }
        }
        
        function clearCurrentNotification() {
            if (activeNotifications.length > 0) {
                // Remove the latest notification
                const latest = activeNotifications[activeNotifications.length - 1];
                hideNotification(latest.id);
            }
        }
        
        function clearAllNotifications() {
            // Clear all timeouts
            notificationTimeouts.forEach(timeout => clearTimeout(timeout));
            notificationTimeouts.clear();
            
            // Clear all notifications
            activeNotifications = [];
            
            // Update display
            updateNotificationDisplay();
        }
        
        // Legacy function for compatibility
        function hideToast(id) {
            // Remove from array
            notifications = notifications.filter(n => n.id !== id);
            
            // Hide if it's the current one
            if (currentNotification && currentNotification.id === id) {
                hideLatestNotification();
            }
        }
        
        // Convenience functions
        function showSuccessToast(message, duration = 3000) {
            return showToast(message, 'success', duration);
        }
        
        function showErrorToast(message, duration = 5000) {
            return showToast(message, 'error', duration);
        }
        
        function showWarningToast(message, duration = 4000) {
            return showToast(message, 'warning', duration);
        }
        
        function showInfoToast(message, duration = 3000) {
            return showToast(message, 'info', duration);
        }
        
        // Dark mode functionality
        function toggleTheme() {
            const body = document.getElementById('mainBody');
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                themeToggle.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                themeToggle.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.getElementById('mainBody');
            const themeToggle = document.getElementById('themeToggle');
            
            // Default to dark mode if no preference is saved
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark');
                if (themeToggle) {
                    themeToggle.classList.add('dark');
                }
            }
        }
        
        // Login functionality
        async function login() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadEnvVars();
                    // Fix header positioning after panel is shown
                    setTimeout(adjustStickyHeaderPositioning, 100);
                } else if (response.status === 429) {
                    // Rate limited - show countdown timer UI
                    const passwordInput = document.getElementById('password');
                    const loginButton = document.getElementById('loginButton');
                    passwordInput.disabled = true;
                    loginButton.disabled = true;

                    // Start countdown timer (this will hide inputs and show timer)
                    if (data.remainingSeconds) {
                        startLoginCountdown(data.remainingSeconds, passwordInput, loginButton, errorDiv);
                    }
                } else {
                    // Show error with attempts remaining if available
                    errorDiv.textContent = data.error || 'Invalid password';
                    if (data.attemptsRemaining !== undefined) {
                        errorDiv.textContent += ` (${data.attemptsRemaining} attempt(s) remaining)`;
                    }
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        function startLoginCountdown(seconds, passwordInput, loginButton, errorDiv) {
            let remaining = seconds;
            const countdownTimer = document.getElementById('countdownTimer');
            const loginInputs = document.getElementById('loginInputs');
            const rateLimitMessage = document.getElementById('rateLimitMessage');

            // Hide login inputs and show rate limit message
            if (loginInputs) loginInputs.classList.add('hidden');
            if (rateLimitMessage) rateLimitMessage.classList.remove('hidden');
            if (errorDiv) errorDiv.classList.add('hidden');

            const updateCountdown = () => {
                if (remaining <= 0) {
                    // Re-enable login
                    if (passwordInput) passwordInput.disabled = false;
                    if (loginButton) loginButton.disabled = false;
                    if (loginInputs) loginInputs.classList.remove('hidden');
                    if (rateLimitMessage) rateLimitMessage.classList.add('hidden');
                    if (errorDiv) errorDiv.classList.add('hidden');
                    return;
                }

                // Update timer display (MM:SS format)
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                if (countdownTimer) {
                    countdownTimer.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                }

                remaining--;
                setTimeout(updateCountdown, 1000);
            };

            updateCountdown();
        }
        
        async function logout() {
            try {
                await fetch('/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.log('Logout request failed, but continuing with local logout');
            }
            
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('password').value = '';
        }
        
        // Environment variables functionality
        async function loadEnvVars() {
            try {
                const response = await fetch('/admin/api/env');
                envVars = await response.json();
                renderEnvVars();
                // Update provider preview when env vars are loaded
                updateProviderPreview();
            } catch (error) {
                showError('envError', 'Failed to load environment variables: ' + error.message);
            }
        }
        
        let originalValues = {};
        
        function renderEnvVars() {
            
            // Render providers
            renderProviders();
        }

        function renderProviders() {
            const providersContainer = document.getElementById('providersContainer');
            providersContainer.innerHTML = '';
            
            // Group environment variables by provider
            const providers = {};
            
            for (const [key, value] of Object.entries(envVars)) {
                if (key.endsWith('_API_KEYS') && value) {
                    // First try to match the pattern APITYPE_PROVIDERNAME_API_KEYS
                    // We need to split only on the FIRST underscore to preserve provider names with underscores
                    const keyWithoutSuffix = key.replace('_API_KEYS', '');
                    const firstUnderscoreIndex = keyWithoutSuffix.indexOf('_');

                    if (firstUnderscoreIndex > 0) {
                        const apiType = keyWithoutSuffix.substring(0, firstUnderscoreIndex).toLowerCase();
                        const providerName = keyWithoutSuffix.substring(firstUnderscoreIndex + 1).toLowerCase();
                        const providerKey = `${apiType}_${providerName}`;
                        
                        if (!providers[providerKey]) {
                            providers[providerKey] = {
                                name: providerName,
                                apiType: apiType,
                                keys: [],
                                baseUrl: '',
                                accessKey: '',
                                defaultModel: '',
                                modelHistory: []
                            };
                        }
                        providers[providerKey].keys = value.split(',').map(k => k.trim()).filter(k => k);
                    }
                } else if (key.endsWith('_BASE_URL') && value) {
                    const match = key.match(/^(.+)_(.+)_BASE_URL$/);
                    if (match && match.length >= 3) {
                        const apiType = match[1].toLowerCase();
                        const providerName = match[2].toLowerCase();
                        const providerKey = `${apiType}_${providerName}`;
                        
                        if (!providers[providerKey]) {
                            providers[providerKey] = {
                                name: providerName,
                                apiType: apiType,
                                keys: [],
                                baseUrl: '',
                                accessKey: '',
                                defaultModel: '',
                                modelHistory: []
                            };
                        }
                        providers[providerKey].baseUrl = value;
                    }
                } else if (key.endsWith('_ACCESS_KEY') && value) {
                    const match = key.match(/^(.+)_(.+)_ACCESS_KEY$/);
                    if (match && match.length >= 3) {
                        const apiType = match[1].toLowerCase();
                        const providerName = match[2].toLowerCase();
                        const providerKey = `${apiType}_${providerName}`;

                        if (!providers[providerKey]) {
                            providers[providerKey] = {
                                name: providerName,
                                apiType: apiType,
                                keys: [],
                                baseUrl: '',
                                accessKey: '',
                                defaultModel: '',
                                modelHistory: []
                            };
                        }
                        providers[providerKey].accessKey = value;
                    }
                } else if (key.endsWith('_DEFAULT_MODEL') && value) {
                    // Extract API_TYPE and PROVIDER from key
                    const parts = key.replace('_DEFAULT_MODEL', '').split('_');
                    if (parts.length < 2) continue;

                    const apiType = parts[0].toLowerCase();
                    const providerName = parts.slice(1).join('_').toLowerCase();
                    const providerKey = `${apiType}_${providerName}`;

                    if (!providers[providerKey]) {
                        providers[providerKey] = {
                            name: providerName,
                            apiType: apiType,
                            keys: [],
                            baseUrl: '',
                            accessKey: '',
                            defaultModel: '',
                            modelHistory: []
                        };
                    }
                    providers[providerKey].defaultModel = value;
                } else if (key.endsWith('_MODEL_HISTORY') && value) {
                    // Extract API_TYPE and PROVIDER from key
                    const parts = key.replace('_MODEL_HISTORY', '').split('_');
                    if (parts.length < 2) continue;

                    const apiType = parts[0].toLowerCase();
                    const providerName = parts.slice(1).join('_').toLowerCase();
                    const providerKey = `${apiType}_${providerName}`;

                    if (!providers[providerKey]) {
                        providers[providerKey] = {
                            name: providerName,
                            apiType: apiType,
                            keys: [],
                            baseUrl: '',
                            accessKey: '',
                            defaultModel: '',
                            modelHistory: []
                        };
                    }
                    providers[providerKey].modelHistory = value.split(',').map(m => m.trim()).filter(m => m);
                }
            }

            // Add current default model to each provider's history if it exists
            Object.values(providers).forEach(provider => {
                // If provider has a default model, ensure it's in the history
                if (provider.defaultModel && provider.defaultModel.trim()) {
                    const currentModel = provider.defaultModel.trim();

                    // Remove if already exists (to re-add at front)
                    const filteredHistory = provider.modelHistory.filter(m => m !== currentModel);

                    // Add current model at the front
                    provider.modelHistory = [currentModel, ...filteredHistory].slice(0, 15);
                }
            });

            // Display each provider
            Object.values(providers).forEach((provider, index) => {
                const providerDiv = document.createElement('div');
                providerDiv.className = 'key-row';

                // Determine initial button state for access key
                let accessKeyButtonHtml, accessKeyAction, accessKeyClass, accessKeyStyle, accessKeyTitle;

                if (provider.accessKey) {
                    // Has value - show delete icon
                    accessKeyButtonHtml = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>`;
                    accessKeyAction = `deleteAccessKey('${provider.apiType}', '${provider.name}')`;
                    accessKeyClass = 'text-muted-foreground hover:text-foreground p-1';
                    accessKeyStyle = '';
                    accessKeyTitle = 'Delete';
                } else {
                    // Empty - show disabled save icon
                    accessKeyButtonHtml = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 19V13H17V19H19V7.828L16.172 5H15V9H9V5H5V19H7ZM17 5V7H15V5H17ZM19 3L21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19Z"></path>
                       </svg>`;
                    accessKeyAction = '';  // No action when disabled
                    accessKeyClass = 'cursor-not-allowed p-1';
                    accessKeyStyle = 'pointer-events: none; opacity: 0.3;';
                    accessKeyTitle = 'Nothing to save';
                }

                // Determine initial button state for default model
                let defaultModelButtonHtml, defaultModelAction, defaultModelClass, defaultModelStyle, defaultModelTitle;

                if (provider.defaultModel) {
                    // Has value - show delete icon
                    defaultModelButtonHtml = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>`;
                    defaultModelAction = `deleteDefaultModel('${provider.apiType}', '${provider.name}')`;
                    defaultModelClass = 'absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground p-1';
                    defaultModelStyle = '';
                    defaultModelTitle = 'Delete';
                } else {
                    // Empty - show disabled save icon
                    defaultModelButtonHtml = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 19V13H17V19H19V7.828L16.172 5H15V9H9V5H5V19H7ZM17 5V7H15V5H17ZM19 3L21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19Z"></path>
                       </svg>`;
                    defaultModelAction = '';  // No action when disabled
                    defaultModelClass = 'absolute right-2 top-1/2 -translate-y-1/2 cursor-not-allowed p-1';
                    defaultModelStyle = 'pointer-events: none; opacity: 0.3;';
                    defaultModelTitle = 'Nothing to save';
                }

                providerDiv.innerHTML = `
                    <div class="space-y-4">
                        <!-- Header with provider name and actions -->
                        <div class="flex items-center justify-between">
                            <div id="provider-name-${provider.apiType}-${provider.name}">
                                <h4 class="text-sm font-medium text-foreground">${provider.name}</h4>
                                <p class="text-xs text-muted-foreground">${provider.apiType.toUpperCase()} Compatible â€¢ ${provider.keys.length} keys</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button
                                    onclick="startRenameProvider('${provider.apiType}', '${provider.name}')"
                                    class="btn btn-secondary px-2 py-1 text-xs font-medium"
                                    title="Rename provider"
                                >
                                    <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                    Rename
                                </button>
                                <button
                                    onclick="copyProviderCurl('${provider.apiType}', '${provider.name}')"
                                    class="btn btn-secondary px-2 py-1 text-xs font-medium"
                                    title="Copy cURL test command"
                                >
                                    ðŸ“‹ Copy cURL
                                </button>
                                <button
                                    onclick="showDeleteProviderConfirmation('${provider.apiType}', '${provider.name}')"
                                    class="text-destructive hover:text-destructive/80 transition-colors p-1"
                                    title="Delete Provider"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Configuration Section -->
                        <div class="bg-muted/30 rounded-lg p-3 space-y-3">
                            <div class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2">Configuration</div>

                            <!-- URLs Row -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-muted-foreground mb-1.5 font-medium">Original Base URL</label>
                                    <div class="relative">
                                        <div class="font-mono text-foreground bg-muted/30 border border-border px-3 py-2 pr-10 rounded text-xs">
                                            ${provider.baseUrl || 'Using Default URL'}
                                        </div>
                                        <button
                                            onclick="copyOriginalBaseUrl('${provider.baseUrl || ''}')"
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors p-1"
                                            title="Copy original base URL"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-muted-foreground mb-1.5 font-medium">Your Endpoint URL</label>
                                    <div class="relative">
                                        <div class="font-mono text-foreground bg-muted/30 border border-border px-3 py-2 pr-10 rounded text-xs">
                                            <span class="text-muted-foreground">${window.location.protocol}//${window.location.host}/</span><span class="text-primary font-semibold">${provider.name}</span><span class="text-muted-foreground">/*</span>
                                        </div>
                                        <button
                                            onclick="copyEndpointUrl('${provider.name}')"
                                            class="absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors p-1"
                                            title="Copy full endpoint URL"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Access Key and Default Model Row -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-muted-foreground mb-1.5 font-medium">Access Key (Optional)</label>
                                    <div class="relative">
                                        <input
                                            type="text"
                                            id="accessKey_${provider.apiType}_${provider.name}"
                                            value="${provider.accessKey || ''}"
                                            data-original="${provider.accessKey || ''}"
                                            class="input-field w-full px-3 py-2 pr-28 text-xs rounded transition-colors font-mono"
                                            placeholder="Enter access key or leave empty"
                                            oninput="checkForChanges('accessKey', '${provider.apiType}', '${provider.name}')"
                                            onkeypress="if(event.key === 'Enter') saveAccessKey('${provider.apiType}', '${provider.name}')"
                                        >
                                        <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center">
                                            <button
                                                onclick="generateAccessKey('${provider.apiType}', '${provider.name}')"
                                                class="text-muted-foreground hover:text-foreground transition-colors p-1"
                                                title="Generate new key"
                                            >
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                </svg>
                                            </button>
                                            <button
                                                onclick="copyAccessKey('${provider.apiType}', '${provider.name}')"
                                                class="text-muted-foreground hover:text-foreground transition-colors p-1"
                                                title="Copy access key"
                                            >
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </button>
                                            <button
                                                id="saveBtn_accessKey_${provider.apiType}_${provider.name}"
                                                ${accessKeyAction ? `onclick="${accessKeyAction}"` : ''}
                                                class="${accessKeyClass}"
                                                style="${accessKeyStyle}"
                                                title="${accessKeyTitle}"
                                            >
                                                ${accessKeyButtonHtml}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-muted-foreground mb-1.5 font-medium">Default Model (Optional)</label>
                                    <div class="relative">
                                        <input
                                            type="text"
                                            id="defaultModel_${provider.apiType}_${provider.name}"
                                            value="${provider.defaultModel || ''}"
                                            data-original="${provider.defaultModel || ''}"
                                            class="input-field w-full px-3 py-2 pr-20 text-xs rounded transition-colors"
                                            placeholder="${provider.apiType === 'openai' ? 'e.g., gpt-4o-mini' : 'e.g., gemini-1.5-flash'}"
                                            oninput="checkForChanges('defaultModel', '${provider.apiType}', '${provider.name}')"
                                            onkeypress="if(event.key === 'Enter') saveDefaultModel('${provider.apiType}', '${provider.name}')"
                                            autocomplete="off"
                                        >
                                        <button
                                            id="historyBtn_defaultModel_${provider.apiType}_${provider.name}"
                                            onclick="toggleModelHistory('${provider.apiType}', '${provider.name}')"
                                            class="absolute right-12 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground p-1 transition-colors"
                                            title="Model History"
                                            ${(!provider.modelHistory || provider.modelHistory.length === 0) ? 'disabled style="opacity: 0.3; cursor: not-allowed; pointer-events: none;"' : ''}
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        <button
                                            id="saveBtn_defaultModel_${provider.apiType}_${provider.name}"
                                            ${defaultModelAction ? `onclick="${defaultModelAction}"` : ''}
                                            class="${defaultModelClass}"
                                            style="${defaultModelStyle}"
                                            title="${defaultModelTitle}"
                                        >
                                            ${defaultModelButtonHtml}
                                        </button>
                                        <div id="modelHistory_${provider.apiType}_${provider.name}" class="hidden absolute top-full left-0 right-0 mt-1 bg-card border border-border rounded shadow-lg z-10 max-h-48 overflow-y-auto">
                                            ${(provider.modelHistory && provider.modelHistory.length > 0) ? provider.modelHistory.map(model => `
                                                <div class="flex items-center justify-between px-3 py-2 text-xs hover:bg-secondary transition-colors group">
                                                    <button
                                                        onclick="selectModelFromHistory('${provider.apiType}', '${provider.name}', '${model.replace(/'/g, "\\'")}')"
                                                        class="flex-1 text-left"
                                                    >
                                                        ${model}
                                                    </button>
                                                    <button
                                                        onclick="showDeleteModelConfirmation(event, '${provider.apiType}', '${provider.name}', '${model.replace(/'/g, "\\'")}')"
                                                        class="ml-2 text-muted-foreground hover:text-destructive transition-colors opacity-0 group-hover:opacity-100"
                                                        title="Remove from history"
                                                    >
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            `).join('') : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-muted-foreground mb-1 text-xs">API Keys</label>
                            <div class="space-y-1">
                                ${provider.keys.map((key, keyIndex) => `
                                    <div class="flex items-center space-x-2">
                                        <div class="flex-1 font-mono text-xs text-foreground bg-muted px-2 py-1 rounded">
                                            ${key.length > 16 ? key.substring(0, 8) + '...' + key.slice(-4) : key}
                                        </div>
                                        <button 
                                            onclick="testProviderKey('${provider.apiType}', '${provider.name}', '${key}', ${keyIndex})" 
                                            class="btn btn-secondary px-2 py-1 text-xs font-medium"
                                        >
                                            Test
                                        </button>
                                        <button 
                                            onclick="showDeleteKeyConfirmation('${provider.apiType}', '${provider.name}', ${keyIndex})" 
                                            class="btn btn-destructive px-2 py-1 text-xs font-medium"
                                            title="Delete Key"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                `).join('')}
                                <div class="flex items-center space-x-2 mt-2 pt-2 border-t border-border">
                                    <input 
                                        type="text" 
                                        id="newKey_${provider.apiType}_${provider.name}" 
                                        class="input-field flex-1 px-2 py-1 text-xs rounded transition-colors" 
                                        placeholder="Enter new API key"
                                    >
                                    <button 
                                        onclick="testProviderNewKey('${provider.apiType}', '${provider.name}')" 
                                        class="btn btn-secondary px-2 py-1 text-xs font-medium"
                                    >
                                        Test
                                    </button>
                                    <button 
                                        onclick="saveProviderKey('${provider.apiType}', '${provider.name}')" 
                                        class="btn btn-primary px-2 py-1 text-xs font-medium"
                                    >
                                        Test & Save
                                    </button>
                                </div>
                                <div id="newKeyResult_${provider.apiType}_${provider.name}" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                `;
                providersContainer.appendChild(providerDiv);
            });
            
            if (Object.keys(providers).length === 0) {
                providersContainer.innerHTML = '<div class="text-muted-foreground text-sm text-center py-4">No providers configured yet. Add one below.</div>';
            }
        }
        
        // Removed legacy key rendering - now everything is managed as providers
        
        function updateEnvVar(key, value) {
            envVars[key] = value;
        }
        
        // Removed old input change handlers - no longer needed
        
        // Legacy functions removed - using provider management instead
        
        // Moved to removeLegacyKey function
        
        // Confirmation dialog variables
        let pendingDelete = null;
        
        // Removed - using direct confirmation instead
        
        // Removed - no longer needed
        
        function cancelDelete() {
            pendingDelete = null;
            document.getElementById('confirmDialog').classList.add('hidden');
        }
        
        function confirmDelete() {
            if (pendingDelete) {
                // No pending deletes in new system
            }
            document.getElementById('confirmDialog').classList.add('hidden');
        }
        
        // Helper function to get default provider configuration
        function getDefaultProviderConfig(apiType) {
            const defaults = {
                openai: {
                    name: 'openai',
                    baseUrl: 'https://api.openai.com/v1'
                },
                gemini: {
                    name: 'gemini',
                    baseUrl: 'https://generativelanguage.googleapis.com/v1'
                }
            };
            return defaults[apiType] || null;
        }

        // Update the provider preview dynamically
        function updateProviderPreview() {
            const name = document.getElementById('newProviderName').value.trim();
            const apiType = document.getElementById('newProviderApiType').value;
            const baseUrl = document.getElementById('newProviderBaseUrl').value.trim();
            const previewElement = document.getElementById('previewText');
            
            if (!previewElement) return;
            
            const defaultConfig = getDefaultProviderConfig(apiType);
            if (!defaultConfig) {
                previewElement.textContent = 'Unknown API type';
                return;
            }
            
            const hasName = name.length > 0;
            const hasBaseUrl = baseUrl.length > 0;
            
            // Check for validation errors
            if (hasName && !hasBaseUrl) {
                previewElement.innerHTML = `<span style="color: var(--destructive);">âš ï¸ <strong>Validation Error:</strong> Provider name provided but base URL is missing. Please provide both or leave both empty for default.</span>`;
                previewElement.parentElement.style.borderColor = 'var(--destructive)';
                previewElement.parentElement.style.backgroundColor = 'rgb(239 68 68 / 0.1)';
                return;
            }
            
            if (!hasName && hasBaseUrl) {
                previewElement.innerHTML = `<span style="color: var(--destructive);">âš ï¸ <strong>Validation Error:</strong> Base URL provided but provider name is missing. Please provide both or leave both empty for default.</span>`;
                previewElement.parentElement.style.borderColor = 'var(--destructive)';
                previewElement.parentElement.style.backgroundColor = 'rgb(239 68 68 / 0.1)';
                return;
            }
            
            // Reset preview styling for valid inputs
            previewElement.parentElement.style.borderColor = 'var(--border)';
            previewElement.parentElement.style.backgroundColor = 'var(--muted)/20';
            
            // Valid combinations
            if (!hasName && !hasBaseUrl) {
                // Default provider
                previewElement.innerHTML = `Will create <strong>default ${apiType.toUpperCase()}</strong> provider '<strong>${defaultConfig.name}</strong>' â†’ <code>${defaultConfig.baseUrl}</code>`;
            } else {
                // Custom provider (both name and base URL provided)
                previewElement.innerHTML = `Will create <strong>custom</strong> provider '<strong>${name}</strong>' â†’ <code>${baseUrl}</code>`;
            }
        }

        // New provider functions
        async function addNewProvider() {
            let name = document.getElementById('newProviderName').value.trim();
            const apiType = document.getElementById('newProviderApiType').value;
            let baseUrl = document.getElementById('newProviderBaseUrl').value.trim();
            const resultDiv = document.getElementById('newProviderResult');

            // Check for trailing slash in base URL
            if (baseUrl && baseUrl.endsWith('/')) {
                showErrorToast('Please remove the trailing slash from the base URL before saving');
                return;
            }
            
            // Collect all API keys
            const keyInputs = document.querySelectorAll('.new-provider-key');
            const apiKeys = [];
            for (const input of keyInputs) {
                const key = input.value.trim();
                if (key) {
                    apiKeys.push(key);
                }
            }
            
            if (apiKeys.length === 0) {
                showWarningToast('At least one API key is required');
                return;
            }

            // Validate that if either name or base URL is provided, both must be provided
            const hasName = name.length > 0;
            const hasBaseUrl = baseUrl.length > 0;
            
            if (hasName && !hasBaseUrl) {
                showErrorToast('If you provide a provider name, you must also provide a base URL (or leave both empty for default)');
                return;
            }
            
            if (!hasName && hasBaseUrl) {
                showErrorToast('If you provide a base URL, you must also provide a provider name (or leave both empty for default)');
                return;
            }

            // Handle default provider creation
            const isDefaultProvider = !hasName && !hasBaseUrl;
            if (isDefaultProvider) {
                const defaultConfig = getDefaultProviderConfig(apiType);
                if (!defaultConfig) {
                    showErrorToast('Unknown API type for default provider');
                    return;
                }
                
                name = defaultConfig.name;
                baseUrl = defaultConfig.baseUrl;
                
                showInfoToast(`Creating default ${apiType.toUpperCase()} provider '${name}' with base URL: ${baseUrl}`);
            } else {
                showInfoToast(`Creating custom provider '${name}' with base URL: ${baseUrl}`);
            }
            
            // Validate provider name (alphanumeric and underscores only)
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                showErrorToast('Provider name can only contain letters, numbers, and underscores');
                return;
            }

            // Test all API keys before saving
            showInfoToast('Testing all API keys before saving...');
            let allKeysValid = true;
            const testedKeys = [];
            
            for (let i = 0; i < apiKeys.length; i++) {
                const apiKey = apiKeys[i];
                const maskedKey = apiKey.length > 16 ? apiKey.substring(0, 8) + '...' + apiKey.slice(-4) : apiKey;
                
                try {
                    showInfoToast(`Testing API key ${i + 1}/${apiKeys.length}: ${maskedKey}...`);
                    const response = await fetch('/admin/api/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            apiType: apiType, 
                            apiKey: apiKey,
                            baseUrl: baseUrl 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        testedKeys.push(apiKey);
                        showSuccessToast(`âœ… API key ${maskedKey} is valid`);
                    } else {
                        showErrorToast(`âŒ API key ${maskedKey} failed: ${result.error || 'Unknown error'}`);
                        allKeysValid = false;
                    }
                } catch (error) {
                    showErrorToast(`âŒ Failed to test API key ${maskedKey}: ${error.message}`);
                    allKeysValid = false;
                }
            }

            if (!allKeysValid) {
                if (testedKeys.length > 0) {
                    showWarningToast(`Only ${testedKeys.length}/${apiKeys.length} API keys are valid. Please fix invalid keys and try again.`);
                } else {
                    showErrorToast('No valid API keys found. Please check your keys and try again.');
                }
                return;
            }
            
            // Create environment variable names
            const keysVar = `${apiType.toUpperCase()}_${name.toUpperCase()}_API_KEYS`;
            const baseUrlVar = `${apiType.toUpperCase()}_${name.toUpperCase()}_BASE_URL`;
            
            // Check if provider already exists
            if (envVars[keysVar]) {
                showErrorToast(`Provider '${name}' already exists`);
                return;
            }
            
            // Update envVars with tested keys only
            envVars[keysVar] = testedKeys.join(',');
            if (baseUrl) {
                envVars[baseUrlVar] = baseUrl;
            }
            
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    // Clear form
                    document.getElementById('newProviderName').value = '';
                    document.getElementById('newProviderBaseUrl').value = '';
                    
                    // Clear all key inputs
                    keyInputs.forEach(input => input.value = '');
                    
                    // Reset to single key input
                    const container = document.getElementById('newProviderKeys');
                    container.innerHTML = `
                        <div class="flex items-center space-x-2" data-key-index="0">
                            <input 
                                type="text" 
                                class="input-field flex-1 px-2 py-1.5 text-xs rounded transition-colors new-provider-key" 
                                placeholder="Enter API key"
                                data-key-index="0"
                            >
                            <button 
                                onclick="testNewProviderKey(0)" 
                                class="btn btn-secondary px-2 py-1 text-xs font-medium"
                            >
                                Test
                            </button>
                            <button 
                                onclick="removeNewProviderKey(0)" 
                                class="btn btn-destructive px-2 py-1 text-xs font-medium"
                                style="display: none;"
                            >
                                Remove
                            </button>
                        </div>
                    `;
                    newProviderKeyIndex = 1;
                    
                    renderEnvVars();
                    
                    showSuccessToast(`ðŸŽ‰ Provider '${name}' created successfully with ${testedKeys.length} tested and valid API key${testedKeys.length > 1 ? 's' : ''}!`);
                } else {
                    // Revert changes
                    delete envVars[keysVar];
                    if (baseUrl) delete envVars[baseUrlVar];
                    showErrorToast('Failed to save provider');
                }
            } catch (error) {
                // Revert changes
                delete envVars[keysVar];
                if (baseUrl) delete envVars[baseUrlVar];
                showErrorToast(`Failed to save provider: ${error.message}`);
            }
        }
        
        let newProviderKeyIndex = 1;
        
        function addNewProviderKey() {
            const container = document.getElementById('newProviderKeys');
            const keyDiv = document.createElement('div');
            keyDiv.className = 'flex items-center space-x-2';
            keyDiv.setAttribute('data-key-index', newProviderKeyIndex);
            
            keyDiv.innerHTML = `
                <input 
                    type="text" 
                    class="input-field flex-1 px-2 py-1.5 text-xs rounded transition-colors new-provider-key" 
                    placeholder="Enter API key"
                    data-key-index="${newProviderKeyIndex}"
                >
                <button 
                    onclick="testNewProviderKey(${newProviderKeyIndex})" 
                    class="btn btn-secondary px-2 py-1 text-xs font-medium"
                >
                    Test
                </button>
                <button 
                    onclick="removeNewProviderKey(${newProviderKeyIndex})" 
                    class="btn btn-destructive px-2 py-1 text-xs font-medium"
                >
                    Remove
                </button>
            `;
            
            container.appendChild(keyDiv);
            
            // Show remove button on first key if we now have multiple keys
            const firstRemoveBtn = document.querySelector('[data-key-index="0"] button[onclick*="removeNewProviderKey"]');
            if (firstRemoveBtn) {
                firstRemoveBtn.style.display = 'inline-flex';
            }
            
            newProviderKeyIndex++;
        }
        
        function removeNewProviderKey(index) {
            const keyDiv = document.querySelector(`[data-key-index="${index}"]`);
            if (keyDiv) {
                keyDiv.remove();
            }
            
            // Hide remove button on first key if it's the only one left
            const remainingKeys = document.querySelectorAll('#newProviderKeys [data-key-index]');
            if (remainingKeys.length === 1) {
                const firstRemoveBtn = document.querySelector('[data-key-index="0"] button[onclick*="removeNewProviderKey"]');
                if (firstRemoveBtn) {
                    firstRemoveBtn.style.display = 'none';
                }
            }
        }
        
        async function testNewProviderKey(keyIndex) {
            const apiType = document.getElementById('newProviderApiType').value;
            const baseUrl = document.getElementById('newProviderBaseUrl').value.trim();
            const keyInput = document.querySelector(`[data-key-index="${keyIndex}"] input`);
            const apiKey = keyInput.value.trim();
            
            if (!apiKey) {
                showWarningToast('Please enter an API key to test');
                return;
            }
            
            const maskedKey = apiKey.length > 16 ? apiKey.substring(0, 8) + '...' + apiKey.slice(-4) : apiKey;
            showInfoToast(`Testing new API key ${maskedKey}...`);
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: apiKey,
                        baseUrl: baseUrl 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessToast(`âœ… API key ${maskedKey} is valid! Ready to save.`);
                } else {
                    showErrorToast(`âŒ API key ${maskedKey} is invalid: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                showErrorToast(`âŒ API key test failed: ${error.message}`);
            }
        }
        
        function showDeleteProviderConfirmation(apiType, providerName) {
            const dialog = document.getElementById('confirmDialog');
            const message = document.getElementById('confirmMessage');
            
            message.textContent = `Delete provider '${providerName}'? This will remove all its API keys and configuration. This action cannot be undone.`;
            
            // Set up the confirm button to call the actual delete function
            const confirmBtn = dialog.querySelector('button[onclick="confirmDelete()"]');
            confirmBtn.onclick = () => {
                dialog.classList.add('hidden');
                deleteProvider(apiType, providerName);
            };
            
            dialog.classList.remove('hidden');
        }

        // Copy endpoint URL for a provider
        async function copyEndpointUrl(providerName) {
            const baseUrl = `${window.location.protocol}//${window.location.host}`;
            const endpointUrl = `${baseUrl}/${providerName}`;
            await copyToClipboard(endpointUrl, `Endpoint URL copied: ${endpointUrl}`);
        }

        async function copyOriginalBaseUrl(baseUrl) {
            if (!baseUrl || baseUrl === '') {
                showToast('No base URL to copy', 'warning');
                return;
            }
            await copyToClipboard(baseUrl, `Base URL copied: ${baseUrl}`);
        }

        // Generate and copy cURL command for testing a provider
        async function copyProviderCurl(apiType, providerName) {
            const baseUrl = `${window.location.protocol}//${window.location.host}`;
            const accessKeyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_ACCESS_KEY`;
            const accessKey = envVars[accessKeyVar];
            const defaultModelVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_DEFAULT_MODEL`;
            const defaultModel = envVars[defaultModelVar];
            let curlCommand = '';

            // Build auth headers based on API type

            if (apiType === 'openai') {
                // Build Authorization header for OpenAI
                let authContent = '[STATUS_CODES:429]';
                if (accessKey) {
                    authContent += `[ACCESS_KEY:${accessKey}]`;
                }
                const authHeader = `  -H "Authorization: Bearer ${authContent}" \\\n`;

                // Use default model if set, otherwise use YOUR_MODEL_NAME placeholder
                const model = defaultModel || 'YOUR_MODEL_NAME';

                // OpenAI-compatible cURL command
                curlCommand = `curl -X POST "${baseUrl}/${providerName}/chat/completions" \\
${authHeader}  -H "Content-Type: application/json" \\
  -d '{
    "model": "${model}",
    "messages": [
      {
        "role": "user",
        "content": "Hello! Please say hello back."
      }
    ]
  }'`;
            } else if (apiType === 'gemini') {
                // Build x-goog-api-key header for Gemini
                let authContent = '[STATUS_CODES:429]';
                if (accessKey) {
                    authContent += `[ACCESS_KEY:${accessKey}]`;
                }
                const googApiKeyHeader = `  -H "x-goog-api-key: ${authContent}" \\\n`;

                // Use default model if set, otherwise use YOUR_MODEL_NAME placeholder
                const model = defaultModel || 'YOUR_MODEL_NAME';

                // Gemini-compatible cURL command
                curlCommand = `curl -X POST "${baseUrl}/${providerName}/models/${model}:generateContent" \\
${googApiKeyHeader}  -H "Content-Type: application/json" \\
  -d '{
    "contents": [
      {
        "parts": [
          {
            "text": "Hello! Please say hello back."
          }
        ]
      }
    ]
  }'`;
            } else {
                showErrorToast('Unknown API type for cURL generation');
                return;
            }
            
            await copyToClipboard(curlCommand, `ðŸ“‹ cURL command copied for provider '${providerName}'! Ready to test in terminal.`);
        }

        // Export configuration as environment variables
        async function exportConfiguration() {
            try {
                // Fetch the .env file content from the server
                const response = await fetch('/admin/api/env-file');
                if (!response.ok) {
                    throw new Error('Failed to fetch .env file');
                }

                let envContent = await response.text();

                // Replace ADMIN_PASSWORD value with empty string
                envContent = envContent.replace(/^ADMIN_PASSWORD=.*$/m, 'ADMIN_PASSWORD=');

                // Copy to clipboard
                await copyToClipboard(envContent, '.env configuration copied to clipboard! Ready to paste.');

            } catch (error) {
                console.error('Export error:', error);
                showErrorToast('Failed to export configuration: ' + error.message);
            }
        }

        async function deleteProvider(apiType, providerName) {
            const providerPrefix = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_`;

            // Delete all environment variables that start with the provider prefix
            const keysToDelete = [];
            for (const key in envVars) {
                if (key.startsWith(providerPrefix)) {
                    keysToDelete.push(key);
                }
            }

            // Remove all matching keys from envVars
            keysToDelete.forEach(key => {
                console.log(`Deleting env var: ${key}`);
                delete envVars[key];
            });

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    renderEnvVars();
                    showSuccessToast(`ðŸ—‘ï¸ Provider '${providerName}' deleted successfully (${keysToDelete.length} settings removed)`);
                } else {
                    showErrorToast('Failed to delete provider');
                }
            } catch (error) {
                showErrorToast(`Failed to delete provider: ${error.message}`);
            }
        }

        // Check for changes in input fields and update save/delete button
        function checkForChanges(fieldType, apiType, providerName) {
            const inputId = `${fieldType}_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);
            const saveBtnId = `saveBtn_${fieldType}_${apiType}_${providerName}`;
            const saveBtn = document.getElementById(saveBtnId);

            if (!input || !saveBtn) return;

            const originalValue = input.getAttribute('data-original') || '';
            const currentValue = input.value.trim();

            // Determine button position class (without transitions for smooth state changes)
            const positionClass = fieldType === 'accessKey'
                ? 'text-muted-foreground hover:text-foreground p-1'
                : 'absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground p-1';

            if (currentValue !== originalValue) {
                // There are changes - show save icon (enabled)
                saveBtn.className = positionClass;
                saveBtn.title = 'Save changes';
                saveBtn.style.pointerEvents = '';  // Re-enable pointer events
                saveBtn.style.opacity = '1';  // Explicitly set to full opacity
                saveBtn.onclick = () => {
                    if (fieldType === 'accessKey') {
                        saveAccessKey(apiType, providerName);
                    } else {
                        saveDefaultModel(apiType, providerName);
                    }
                };
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 19V13H17V19H19V7.828L16.172 5H15V9H9V5H5V19H7ZM17 5V7H15V5H17ZM19 3L21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19Z"></path>
                    </svg>
                `;
            } else if (originalValue && currentValue === originalValue) {
                // No changes and has existing value - show delete icon
                saveBtn.className = positionClass;
                saveBtn.title = 'Delete';
                saveBtn.style.pointerEvents = '';  // Re-enable pointer events
                saveBtn.style.opacity = '1';  // Explicitly set to full opacity
                saveBtn.onclick = () => {
                    if (fieldType === 'accessKey') {
                        deleteAccessKey(apiType, providerName);
                    } else {
                        deleteDefaultModel(apiType, providerName);
                    }
                };
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                `;
            } else {
                // Empty field - show disabled save icon
                const disabledClass = fieldType === 'accessKey'
                    ? 'cursor-not-allowed p-1'
                    : 'absolute right-2 top-1/2 -translate-y-1/2 cursor-not-allowed p-1';

                saveBtn.className = disabledClass;
                saveBtn.title = 'Nothing to save';
                saveBtn.onclick = null;  // Disable click
                saveBtn.style.pointerEvents = 'none';  // Prevent hover effects
                saveBtn.style.opacity = '0.3';  // Make it very faded (only use inline style, not class)
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 19V13H17V19H19V7.828L16.172 5H15V9H9V5H5V19H7ZM17 5V7H15V5H17ZM19 3L21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19Z"></path>
                    </svg>
                `;
            }
        }

        // ACCESS_KEY Management Functions
        function generateAccessKey(apiType, providerName) {
            // Generate a random access key
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
            let key = '';
            for (let i = 0; i < 32; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            const inputId = `accessKey_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.value = key;
                // Trigger change detection to update button
                checkForChanges('accessKey', apiType, providerName);
                showSuccessToast('Generated new access key - click save to apply');
            }
        }

        async function copyAccessKey(apiType, providerName) {
            const inputId = `accessKey_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);

            if (!input || !input.value) {
                showWarningToast('No access key to copy');
                return;
            }

            await copyToClipboard(input.value, 'Access key copied to clipboard');
        }

        async function saveDefaultModel(apiType, providerName) {
            const inputId = `defaultModel_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);

            if (!input) {
                showErrorToast('Default model input not found');
                return;
            }

            const defaultModel = input.value.trim();
            const oldModel = input.getAttribute('data-original'); // Capture before any changes
            const modelVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_DEFAULT_MODEL`;
            const historyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_MODEL_HISTORY`;

            // Get current history
            const currentHistory = envVars[historyVar] ? envVars[historyVar].split(',').map(m => m.trim()).filter(m => m) : [];

            if (defaultModel) {
                envVars[modelVar] = defaultModel;

                // Add to model history if not already there
                if (!currentHistory.includes(defaultModel)) {
                    currentHistory.push(defaultModel);
                }

                // Sort alphabetically and keep max 15
                const newHistory = currentHistory.sort((a, b) => a.localeCompare(b)).slice(0, 15);
                envVars[historyVar] = newHistory.join(',');
            } else {
                // When default model is removed, add the old model to history
                if (oldModel && oldModel.trim() && !currentHistory.includes(oldModel.trim())) {
                    currentHistory.push(oldModel.trim());
                }

                // Sort alphabetically and keep max 15
                const newHistory = currentHistory.sort((a, b) => a.localeCompare(b)).slice(0, 15);

                // Only set history if there are models
                if (newHistory.length > 0) {
                    envVars[historyVar] = newHistory.join(',');
                } else {
                    delete envVars[historyVar];
                }

                delete envVars[modelVar];
            }

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    // Update the data-original attribute to the new value
                    input.setAttribute('data-original', defaultModel);
                    // Reset the save button color
                    checkForChanges('defaultModel', apiType, providerName);

                    renderEnvVars();
                    if (defaultModel) {
                        showSuccessToast(`ðŸŽ¯ Default model saved for provider '${providerName}': ${defaultModel}`);
                    } else {
                        showSuccessToast(`Default model removed for provider '${providerName}'`);
                    }
                } else {
                    showErrorToast('Failed to save default model');
                }
            } catch (error) {
                showErrorToast(`Failed to save default model: ${error.message}`);
            }
        }

        async function saveAccessKey(apiType, providerName) {
            const inputId = `accessKey_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);

            if (!input) {
                showErrorToast('Access key input not found');
                return;
            }

            const accessKey = input.value.trim();
            const accessKeyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_ACCESS_KEY`;

            if (accessKey) {
                envVars[accessKeyVar] = accessKey;
            } else {
                delete envVars[accessKeyVar];
            }

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    // Update the data-original attribute to the new value
                    input.setAttribute('data-original', accessKey);
                    // Reset the save button color
                    checkForChanges('accessKey', apiType, providerName);

                    renderEnvVars();
                    if (accessKey) {
                        showSuccessToast(`ðŸ” Access key saved for provider '${providerName}'`);
                    } else {
                        showSuccessToast(`ðŸ”“ Access key removed for provider '${providerName}'`);
                    }
                } else {
                    showErrorToast('Failed to save access key');
                }
            } catch (error) {
                showErrorToast(`Failed to save access key: ${error.message}`);
            }
        }

        async function deleteAccessKey(apiType, providerName) {
            const inputId = `accessKey_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);

            if (!input) return;

            // Clear the input
            input.value = '';

            const accessKeyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_ACCESS_KEY`;
            delete envVars[accessKeyVar];

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    // Update the data-original attribute
                    input.setAttribute('data-original', '');
                    // Update button
                    checkForChanges('accessKey', apiType, providerName);
                    renderEnvVars();
                    showSuccessToast(`ðŸ”“ Access key removed for provider '${providerName}'`);
                } else {
                    showErrorToast('Failed to delete access key');
                }
            } catch (error) {
                showErrorToast(`Failed to delete access key: ${error.message}`);
            }
        }

        async function deleteDefaultModel(apiType, providerName) {
            const inputId = `defaultModel_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);

            if (!input) return;

            const oldModel = input.getAttribute('data-original'); // Capture before clearing
            const modelVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_DEFAULT_MODEL`;
            const historyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_MODEL_HISTORY`;

            // Clear the input
            input.value = '';

            // Get current history
            const currentHistory = envVars[historyVar] ? envVars[historyVar].split(',').map(m => m.trim()).filter(m => m) : [];

            // Add the old model to history if it's not empty and not already there
            if (oldModel && oldModel.trim() && !currentHistory.includes(oldModel.trim())) {
                currentHistory.push(oldModel.trim());
            }

            // Sort alphabetically and keep max 15
            const newHistory = currentHistory.sort((a, b) => a.localeCompare(b)).slice(0, 15);

            // Update history if there are models
            if (newHistory.length > 0) {
                envVars[historyVar] = newHistory.join(',');
            }

            delete envVars[modelVar];

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    // Update the data-original attribute
                    input.setAttribute('data-original', '');
                    // Update button
                    checkForChanges('defaultModel', apiType, providerName);
                    renderEnvVars();
                    showSuccessToast(`Default model removed for provider '${providerName}'`);
                } else {
                    showErrorToast('Failed to delete default model');
                }
            } catch (error) {
                showErrorToast(`Failed to delete default model: ${error.message}`);
            }
        }

        function toggleModelHistory(apiType, providerName) {
            const historyId = `modelHistory_${apiType}_${providerName}`;
            const historyDiv = document.getElementById(historyId);

            if (!historyDiv) return;

            // Close all other open dropdowns
            document.querySelectorAll('[id^="modelHistory_"]').forEach(div => {
                if (div.id !== historyId) {
                    div.classList.add('hidden');
                }
            });

            // Toggle current dropdown
            historyDiv.classList.toggle('hidden');
        }

        function showDeleteModelConfirmation(event, apiType, providerName, model) {
            // Prevent the click from bubbling up to selectModelFromHistory
            event.stopPropagation();

            const dialog = document.getElementById('confirmDialog');
            const message = document.getElementById('confirmMessage');

            message.textContent = `Remove "${model}" from history?`;

            // Set up the confirm button to call the actual delete function
            const confirmBtn = dialog.querySelector('button[onclick="confirmDelete()"]');
            confirmBtn.onclick = () => {
                dialog.classList.add('hidden');
                deleteModelFromHistory(apiType, providerName, model);
            };

            dialog.classList.remove('hidden');
        }

        async function deleteModelFromHistory(apiType, providerName, model) {
            const historyVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_MODEL_HISTORY`;

            // Get current history
            const currentHistory = envVars[historyVar] ? envVars[historyVar].split(',').map(m => m.trim()).filter(m => m) : [];

            // Remove the model
            const newHistory = currentHistory.filter(m => m !== model);

            // Update or delete history
            if (newHistory.length > 0) {
                envVars[historyVar] = newHistory.join(',');
            } else {
                delete envVars[historyVar];
            }

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    renderEnvVars();
                    showSuccessToast(`Removed "${model}" from history`);
                } else {
                    showErrorToast('Failed to remove model from history');
                }
            } catch (error) {
                showErrorToast(`Failed to remove model from history: ${error.message}`);
            }
        }

        function selectModelFromHistory(apiType, providerName, model) {
            const inputId = `defaultModel_${apiType}_${providerName}`;
            const input = document.getElementById(inputId);
            const historyId = `modelHistory_${apiType}_${providerName}`;
            const historyDiv = document.getElementById(historyId);

            if (input) {
                input.value = model;
                checkForChanges('defaultModel', apiType, providerName);
            }

            if (historyDiv) {
                historyDiv.classList.add('hidden');
            }

            // Auto-save the selected model
            saveDefaultModel(apiType, providerName);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[id^="historyBtn_defaultModel_"]') &&
                !event.target.closest('[id^="modelHistory_"]')) {
                document.querySelectorAll('[id^="modelHistory_"]').forEach(div => {
                    div.classList.add('hidden');
                });
            }
        });

        async function testProviderKey(apiType, providerName, apiKey, keyIndex) {
            // Get provider's base URL
            const baseUrlVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_BASE_URL`;
            const baseUrl = envVars[baseUrlVar] || null;
            
            const maskedKey = apiKey.length > 16 ? apiKey.substring(0, 8) + '...' + apiKey.slice(-4) : apiKey;
            showInfoToast(`Testing API key ${maskedKey}...`);
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: apiKey,
                        baseUrl: baseUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessToast(`API key ${maskedKey} is valid!`);
                } else {
                    showErrorToast(`API key ${maskedKey} test failed: ${result.error || 'Invalid key'}`);
                }
            } catch (error) {
                showErrorToast(`API key test failed: ${error.message}`);
            }
        }
        
        function showDeleteKeyConfirmation(apiType, providerName, keyIndex) {
            const dialog = document.getElementById('confirmDialog');
            const message = document.getElementById('confirmMessage');
            
            message.textContent = `Are you sure you want to delete this API key from provider '${providerName}'? This action cannot be undone.`;
            
            // Set up the confirm button to call the actual delete function
            const confirmBtn = dialog.querySelector('button[onclick="confirmDelete()"]');
            confirmBtn.onclick = () => {
                dialog.classList.add('hidden');
                deleteProviderKey(apiType, providerName, keyIndex);
            };
            
            dialog.classList.remove('hidden');
        }
        
        // Rename provider functionality
        function startRenameProvider(apiType, providerName) {
            const nameDiv = document.getElementById(`provider-name-${apiType}-${providerName}`);
            if (!nameDiv) return;

            const currentName = providerName;

            // Create inline edit form
            nameDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <input
                        type="text"
                        id="rename-input-${apiType}-${providerName}"
                        value="${currentName}"
                        data-original="${currentName}"
                        class="px-2 py-1 text-sm border border-border rounded bg-input text-foreground"
                        style="width: 150px;"
                        oninput="handleProviderNameInput(this, '${apiType}', '${providerName}')"
                        onkeydown="handleRenameKeyPress(event, '${apiType}', '${providerName}')"
                    />
                    <button
                        id="rename-save-btn-${apiType}-${providerName}"
                        onclick="confirmRenameProvider('${apiType}', '${providerName}')"
                        class="text-muted-foreground hover:text-foreground p-0.5"
                        title="Save name"
                    >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7 19V13H17V19H19V7.828L16.172 5H15V9H9V5H5V19H7ZM17 5V7H15V5H17ZM19 3L21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19Z"></path>
                        </svg>
                    </button>
                    <button
                        onclick="cancelRenameProvider('${apiType}', '${providerName}')"
                        class="text-muted-foreground hover:text-foreground p-0.5"
                        title="Cancel"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;

            // Focus the input
            setTimeout(() => {
                const input = document.getElementById(`rename-input-${apiType}-${providerName}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 0);
        }

        function handleProviderNameInput(input, apiType, providerName) {
            // Convert to lowercase and keep only letters and numbers
            const originalValue = input.value;
            const cleanedValue = input.value.toLowerCase().replace(/[^a-z0-9]/g, '');

            if (originalValue !== cleanedValue) {
                input.value = cleanedValue;

                // Show warning if any special characters were removed
                if (/[^a-zA-Z0-9]/.test(originalValue)) {
                    showWarningToast('Only lowercase letters and numbers are allowed in provider names');
                }
            }

            // Check for changes and update save button
            const saveBtn = document.getElementById(`rename-save-btn-${apiType}-${providerName}`);
            if (saveBtn) {
                const originalName = input.getAttribute('data-original') || '';
                const currentValue = input.value.trim();

                // Keep button always in default color (no green)
                saveBtn.className = 'text-muted-foreground hover:text-foreground p-0.5';
            }
        }

        function handleBaseUrlInput(input) {
            // Check for trailing slash and show error
            const value = input.value;
            const errorElement = input.parentElement.querySelector('.base-url-error');

            if (value.endsWith('/')) {
                // Add error styling
                input.classList.add('border-destructive', 'focus:ring-destructive');
                input.classList.remove('border-border');

                // Create or update error message
                if (!errorElement) {
                    const error = document.createElement('p');
                    error.className = 'base-url-error text-destructive text-xs mt-1';
                    error.textContent = 'Base URL should not end with a trailing slash (/)';
                    input.parentElement.appendChild(error);
                } else {
                    errorElement.textContent = 'Base URL should not end with a trailing slash (/)';
                }

                // Show error toast
                showErrorToast('Base URL cannot end with a trailing slash');
            } else {
                // Remove error styling
                input.classList.remove('border-destructive', 'focus:ring-destructive');
                input.classList.add('border-border');

                // Remove error message
                if (errorElement) {
                    errorElement.remove();
                }
            }
        }

        function handleRenameKeyPress(event, apiType, providerName) {
            if (event.key === 'Enter') {
                confirmRenameProvider(apiType, providerName);
            } else if (event.key === 'Escape') {
                cancelRenameProvider(apiType, providerName);
            }
        }

        function cancelRenameProvider(apiType, providerName) {
            // Just refresh the provider list to restore original state
            renderProviders();
        }

        async function confirmRenameProvider(apiType, oldName) {
            const input = document.getElementById(`rename-input-${apiType}-${oldName}`);
            if (!input) return;

            const newName = input.value.trim().toLowerCase();

            // Validation
            if (!newName) {
                showWarningToast('Provider name cannot be empty');
                return;
            }

            if (!/^[a-z][a-z0-9]*$/.test(newName)) {
                showWarningToast('Provider name must start with a letter and contain only lowercase letters and numbers');
                return;
            }

            if (newName === oldName) {
                cancelRenameProvider(apiType, oldName);
                return;
            }

            // Check if new name already exists
            const newKeysVar = `${apiType.toUpperCase()}_${newName.toUpperCase()}_API_KEYS`;
            if (envVars[newKeysVar]) {
                showErrorToast(`Provider '${newName}' already exists`);
                return;
            }

            try {
                // Get all old values with the old provider prefix
                const oldPrefix = `${apiType.toUpperCase()}_${oldName.toUpperCase()}_`;
                const newPrefix = `${apiType.toUpperCase()}_${newName.toUpperCase()}_`;

                // Find all environment variables with the old prefix
                const oldVars = {};
                for (const key in envVars) {
                    if (key.startsWith(oldPrefix)) {
                        oldVars[key] = envVars[key];
                    }
                }

                if (Object.keys(oldVars).length === 0) {
                    showErrorToast('Provider not found');
                    return;
                }

                // Create new entries with the new prefix
                for (const [oldKey, value] of Object.entries(oldVars)) {
                    const suffix = oldKey.substring(oldPrefix.length); // Get the part after the prefix (API_KEYS, BASE_URL, etc.)
                    const newKey = newPrefix + suffix;
                    envVars[newKey] = value;
                }

                // Delete all old entries
                for (const key of Object.keys(oldVars)) {
                    delete envVars[key];
                }

                // Save to server
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });

                if (response.ok) {
                    showSuccessToast(`Provider renamed from '${oldName}' to '${newName}'`);
                    await loadEnvVars();
                } else {
                    // Rollback on error - restore old entries and remove new ones
                    for (const [oldKey, value] of Object.entries(oldVars)) {
                        envVars[oldKey] = value;
                    }

                    for (const [oldKey] of Object.entries(oldVars)) {
                        const suffix = oldKey.substring(oldPrefix.length);
                        const newKey = newPrefix + suffix;
                        delete envVars[newKey];
                    }

                    showErrorToast('Failed to rename provider');
                }
            } catch (error) {
                console.error('Rename error:', error);
                showErrorToast('Failed to rename provider: ' + error.message);
            }
        }

        async function deleteProviderKey(apiType, providerName, keyIndex) {

            const keysVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_API_KEYS`;
            const keys = envVars[keysVar] ? envVars[keysVar].split(',') : [];

            keys.splice(keyIndex, 1);

            if (keys.length === 0) {
                // If no keys left, delete the entire provider using the same logic as deleteProvider
                const providerPrefix = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_`;

                // Delete all environment variables that start with the provider prefix
                for (const key in envVars) {
                    if (key.startsWith(providerPrefix)) {
                        console.log(`Deleting env var: ${key}`);
                        delete envVars[key];
                    }
                }
            } else {
                envVars[keysVar] = keys.filter(k => k.trim()).join(',');
            }

            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    renderEnvVars();
                    showSuccessToast(`ðŸ—‘ï¸ API key deleted from provider '${providerName}'`);
                } else {
                    showErrorToast('Failed to delete API key');
                }
            } catch (error) {
                showErrorToast(`Failed to delete API key: ${error.message}`);
            }
        }
        
        async function saveProviderKey(apiType, providerName) {
            const inputId = `newKey_${apiType}_${providerName}`;
            const newKey = document.getElementById(inputId).value.trim();
            
            if (!newKey) {
                showWarningToast('Please enter an API key');
                return;
            }

            const maskedKey = newKey.length > 16 ? newKey.substring(0, 8) + '...' + newKey.slice(-4) : newKey;
            
            // Get the base URL for this provider to use for testing
            const baseUrlVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_BASE_URL`;
            const baseUrl = envVars[baseUrlVar] || '';
            
            // Test the API key before saving
            showInfoToast(`Testing API key ${maskedKey} before saving...`);
            
            try {
                const testResponse = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: newKey,
                        baseUrl: baseUrl 
                    })
                });
                
                const testResult = await testResponse.json();
                
                if (!testResult.success) {
                    showErrorToast(`âŒ API key ${maskedKey} is invalid: ${testResult.error || 'Unknown error'}`);
                    return;
                }
                
                showSuccessToast(`âœ… API key ${maskedKey} is valid! Saving...`);
            } catch (error) {
                showErrorToast(`âŒ Failed to test API key ${maskedKey}: ${error.message}`);
                return;
            }
            
            // If test passes, save the key
            const keysVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_API_KEYS`;
            const existingKeys = envVars[keysVar] ? envVars[keysVar].split(',') : [];
            existingKeys.push(newKey);
            envVars[keysVar] = existingKeys.filter(k => k.trim()).join(',');
            
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    document.getElementById(inputId).value = '';
                    renderEnvVars();
                    
                    showSuccessToast(`âœ… Tested and valid API key ${maskedKey} added to provider '${providerName}'!`);
                } else {
                    showErrorToast('Failed to save API key');
                    // Revert the change
                    const revertedKeys = existingKeys.slice(0, -1);
                    envVars[keysVar] = revertedKeys.filter(k => k.trim()).join(',');
                }
            } catch (error) {
                showErrorToast(`Failed to save API key: ${error.message}`);
                // Revert the change
                const revertedKeys = existingKeys.slice(0, -1);
                envVars[keysVar] = revertedKeys.filter(k => k.trim()).join(',');
            }
        }
        
        async function testProviderNewKey(apiType, providerName) {
            const inputId = `newKey_${apiType}_${providerName}`;
            const newKey = document.getElementById(inputId).value.trim();
            
            if (!newKey) {
                showWarningToast('Please enter an API key to test');
                return;
            }
            
            // Get provider's base URL
            const keysVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_API_KEYS`;
            const baseUrlVar = `${apiType.toUpperCase()}_${providerName.toUpperCase()}_BASE_URL`;
            const baseUrl = envVars[baseUrlVar] || null;
            
            const maskedKey = newKey.length > 16 ? newKey.substring(0, 8) + '...' + newKey.slice(-4) : newKey;
            showInfoToast(`Testing API key ${maskedKey} for provider '${providerName}'...`);
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: newKey,
                        baseUrl: baseUrl
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessToast(`âœ… API key ${maskedKey} is valid! Ready to add to provider '${providerName}'.`);
                } else {
                    showErrorToast(`âŒ API key ${maskedKey} is invalid: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                showErrorToast(`âŒ API key test failed: ${error.message}`);
            }
        }
        
        // Removed legacy key functions - everything is now managed as providers
        
        // Removed old functions - replaced with provider management
        
        // Removed - no longer needed
        
        // Removed - no longer needed
        
        // Removed - no longer needed with new provider system
        
        // Removed - replaced with testNewProvider function

        // Removed legacy API key testing - everything is now provider-based
        
        async function saveEnvVars() {
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    showSuccess('envSuccess', 'Environment variables saved and configuration reloaded!');
                } else {
                    showError('envError', 'Failed to save environment variables');
                }
            } catch (error) {
                showError('envError', 'Save failed: ' + error.message);
            }
        }
        
        // API Testing functionality
        async function testApiKey(apiType) {
            const keyInput = document.getElementById(`${apiType}TestKey`);
            const resultDiv = document.getElementById(`${apiType}TestResult`);
            
            if (!keyInput.value.trim()) {
                resultDiv.innerHTML = '<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3">Please enter an API key</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm mt-3">Testing...</div>';
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: keyInput.value.trim() 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-3 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>API key is valid!</span></div>';
                } else {
                    resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span>${result.error}</span></div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3">Test failed: ${error.message}</div>`;
            }
        }
        
        // Logging functionality

        async function handleRefreshLogs(button) {
            // Add spinning animation to reload button
            if (button) {
                const svg = button.querySelector('svg');
                if (svg) {
                    svg.style.animation = 'spin 1s linear infinite';
                }
                button.disabled = true;
            }
            
            // Call the actual refresh function
            await refreshLogs();
            
            // Remove animation after refresh
            if (button) {
                const svg = button.querySelector('svg');
                if (svg) {
                    svg.style.animation = '';
                }
                button.disabled = false;
            }
        }
        
        async function refreshLogs() {
            try {
                const response = await fetch('/admin/api/logs');
                const data = await response.json();
                
                const logsContainer = document.getElementById('logsContainer');
                if (!data.logs || data.logs.length === 0) {
                    logsContainer.textContent = 'No logs available';
                    return;
                }
                
                // Check if we're receiving the new JSON format
                const isJsonFormat = data.format === 'json' || (data.logs.length > 0 && typeof data.logs[0] === 'object');
                
                let processedLogs;
                
                if (isJsonFormat) {
                    // Deduplicate logs more aggressively
                    const seenRequests = new Map();
                    const uniqueLogs = [];
                    
                    for (const log of data.logs) {
                        let key;
                        if (typeof log === 'object' && log.requestId) {
                            // For objects with requestId, use only requestId as the key
                            // This ensures we only show each request once
                            key = log.requestId;
                        } else if (typeof log === 'string') {
                            // Extract requestId from string format logs
                            const reqIdMatch = log.match(/\[([a-zA-Z0-9]+)\]/);
                            if (reqIdMatch) {
                                key = reqIdMatch[1];
                            } else {
                                // Use the entire string as key if no ID found
                                key = log;
                            }
                        } else {
                            // Fallback to stringified object
                            key = JSON.stringify(log);
                        }
                        
                        if (!seenRequests.has(key)) {
                            seenRequests.set(key, true);
                            uniqueLogs.push(log);
                        }
                    }
                    
                    // New JSON format - create formatted display
                    processedLogs = uniqueLogs.map(log => {
                        if (typeof log === 'string') {
                            // Legacy string format - display as is with view button if possible
                            const testMatch = log.match(/\[TEST-([a-zA-Z0-9]+)\]/);
                            const reqMatch = log.match(/\[REQ-([a-zA-Z0-9]+)\]/);
                            if (testMatch) {
                                const testId = testMatch[1];
                                return log + ` <button onclick="viewResponse('${testId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                            } else if (reqMatch) {
                                const requestId = reqMatch[1];
                                return log + ` <button onclick="viewResponse('${requestId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                            }
                            return log;
                        } else {
                            // New JSON format - create structured display
                            const timestamp = new Date(log.timestamp).toLocaleTimeString();
                            const status = log.status ? `(${log.status})` : '';
                            const responseTime = log.responseTime ? `${log.responseTime}ms` : '';
                            const error = log.error ? ` ERROR: ${log.error}` : '';
                            
                            // Color coding based on status
                            let statusColor = 'text-green-400';
                            if (log.status >= 400) {
                                statusColor = 'text-red-400';
                            } else if (log.status >= 300) {
                                statusColor = 'text-yellow-400';
                            }
                            
                            const logLine = `<span class="text-gray-400">${timestamp}</span> <span class="text-blue-400">[${log.requestId}]</span> <span class="text-white">${log.method} ${log.endpoint}</span> <span class="text-cyan-400">(${log.provider})</span> <span class="${statusColor}">${status}</span> <span class="text-gray-400">${responseTime}</span><span class="text-red-400">${error}</span>`;
                            
                            // Add view button if we have detailed response data
                            if (log.requestId && log.requestId !== 'unknown') {
                                return logLine + ` <button onclick="viewResponse('${log.requestId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                            }
                            return logLine;
                        }
                    }).join('\n');
                } else {
                    // Legacy string format - deduplicate based on request ID
                    const seenIds = new Set();
                    const uniqueLogs = [];
                    
                    for (const log of data.logs) {
                        // Extract any ID from the log string
                        const idMatch = log.match(/\[([a-zA-Z0-9]+)\]/);
                        const logId = idMatch ? idMatch[1] : log;
                        
                        if (!seenIds.has(logId)) {
                            seenIds.add(logId);
                            uniqueLogs.push(log);
                        }
                    }
                    
                    // Legacy string format - old processing
                    processedLogs = uniqueLogs.map(log => {
                        const testMatch = log.match(/\[TEST-([a-zA-Z0-9]+)\]/);
                        if (testMatch) {
                            const testId = testMatch[1];
                            return log + ` <button onclick="viewResponse('${testId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                        }
                        
                        const reqMatch = log.match(/\[REQ-([a-zA-Z0-9]+)\]/);
                        if (reqMatch) {
                            const requestId = reqMatch[1];
                            return log + ` <button onclick="viewResponse('${requestId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                        }
                        
                        return log;
                    }).join('\n');
                }
                
                logsContainer.innerHTML = processedLogs || 'No logs available';
                
                // Auto-scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } catch (error) {
                document.getElementById('logsContainer').textContent = 'Failed to load logs: ' + error.message;
            }
        }

        async function viewResponse(testId) {
            try {
                const response = await fetch(`/admin/api/response/${testId}`);
                if (!response.ok) {
                    alert('Response data not found');
                    return;
                }
                
                const data = await response.json();
                
                // Update dialog content
                document.getElementById('responseInfo').textContent = 
                    `${data.method} ${data.endpoint} (${data.apiType}) â†’ ${data.status} ${data.statusText} | ${data.contentType}`;
                
                // Format JSON response
                let formattedResponse;
                try {
                    const jsonData = JSON.parse(data.responseData);
                    formattedResponse = JSON.stringify(jsonData, null, 2);
                } catch (e) {
                    // Not JSON, show as plain text
                    formattedResponse = data.responseData;
                }
                
                document.getElementById('responseContent').textContent = formattedResponse;
                
                // Handle request body tab
                const requestTab = document.getElementById('requestTab');
                const requestContent = document.getElementById('requestContent');
                
                if (data.requestBody && data.requestBody.trim()) {
                    // Show and enable request tab if there's a request body
                    requestTab.classList.remove('hidden');
                    requestTab.disabled = false;
                    requestTab.title = '';
                    requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-secondary';
                    
                    // Format request body
                    let formattedRequest;
                    try {
                        const requestJson = JSON.parse(data.requestBody);
                        formattedRequest = JSON.stringify(requestJson, null, 2);
                    } catch (e) {
                        formattedRequest = data.requestBody;
                    }
                    
                    requestContent.textContent = formattedRequest;
                } else {
                    // Show but disable request tab if no request body
                    requestTab.classList.remove('hidden');
                    requestTab.disabled = true;
                    requestTab.title = 'No request body available';
                    requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-50';
                    requestContent.textContent = 'No request body data available for this request.';
                }
                
                // Start with response tab active
                switchResponseTab('response');
                
                // Show dialog
                document.getElementById('responseDialog').classList.remove('hidden');
            } catch (error) {
                alert('Failed to load response: ' + error.message);
            }
        }

        function switchResponseTab(tab) {
            const responseTab = document.getElementById('responseTab');
            const requestTab = document.getElementById('requestTab');
            const responseContent = document.getElementById('responseContent');
            const requestContent = document.getElementById('requestContent');
            
            // Don't switch if request tab is disabled and trying to switch to it
            if (tab === 'request' && requestTab.disabled) {
                return;
            }
            
            if (tab === 'response') {
                // Activate response tab
                responseTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-primary';
                // Only update request tab style if it's not disabled
                if (!requestTab.disabled) {
                    requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-secondary';
                }
                responseContent.classList.remove('hidden');
                requestContent.classList.add('hidden');
            } else {
                // Activate request tab (only reachable if not disabled)
                requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-primary';
                responseTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-secondary';
                requestContent.classList.remove('hidden');
                responseContent.classList.add('hidden');
            }
        }

        function closeResponseDialog() {
            document.getElementById('responseDialog').classList.add('hidden');
        }
        
        // Load logs when logs tab is shown
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-muted-foreground');
                btn.classList.remove('text-foreground', 'border-primary');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Set active state on clicked tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active', 'text-foreground', 'border-primary');
            activeBtn.classList.remove('text-muted-foreground');
            
            // Load logs if logs tab is selected
            if (tabName === 'logs') {
                refreshLogs();
            }
        }
        
        // Utility functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        function showSuccess(elementId, message) {
            const successDiv = document.getElementById(elementId);
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 5000);
        }
        
        // Event listeners
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // Dialog keyboard handling
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('confirmDialog').classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    cancelDelete();
                } else if (e.key === 'Enter') {
                    confirmDelete();
                }
            }
        });
        
        // Check authentication on page load
        async function checkAuth() {
            // Always check rate limit status first
            await checkLoginRateLimit();

            try {
                const response = await fetch('/admin/api/auth');
                const data = await response.json();

                if (data.authenticated) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadEnvVars();
                    // Fix header positioning after panel is shown
                    setTimeout(adjustStickyHeaderPositioning, 100);
                }
            } catch (error) {
                console.log('Auth check failed, showing login form');
            }
        }

        async function checkLoginRateLimit() {
            try {
                const response = await fetch('/admin/api/login-status');
                const data = await response.json();

                if (data.blocked) {
                    const passwordInput = document.getElementById('password');
                    const loginButton = document.getElementById('loginButton');
                    const errorDiv = document.getElementById('loginError');

                    if (passwordInput) passwordInput.disabled = true;
                    if (loginButton) loginButton.disabled = true;

                    // Start countdown from remaining seconds
                    startLoginCountdown(data.remainingSeconds, passwordInput, loginButton, errorDiv);
                }
            } catch (error) {
                console.log('Failed to check login rate limit status:', error);
            }
        }
        
        // Setup notification hover functionality
        function setupNotificationHover() {
            const headerNotifications = document.getElementById('headerNotifications');
            const singleNotification = document.getElementById('singleNotification');
            const expandedNotifications = document.getElementById('expandedNotifications');
            
            if (!headerNotifications || !singleNotification || !expandedNotifications) return;
            
            let hoverTimeout;
            
            // Show expanded view on hover
            const showExpanded = () => {
                clearTimeout(hoverTimeout);
                // Only show expanded view if there are notifications
                if (activeNotifications.length > 0) {
                    updateExpandedNotifications();
                    positionNotifications();
                    expandedNotifications.classList.remove('hidden');
                }
            };
            
            headerNotifications.addEventListener('mouseenter', showExpanded);
            singleNotification.addEventListener('mouseenter', showExpanded);
            
            // Hide expanded view on leave with small delay
            headerNotifications.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    expandedNotifications.classList.add('hidden');
                }, 200); // Small delay to prevent flickering
            });
            
            // Keep expanded view open if hovering over it
            expandedNotifications.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
            });
            
            expandedNotifications.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    expandedNotifications.classList.add('hidden');
                }, 200);
            });
        }
        
        // Fix sticky header positioning
        function adjustStickyHeaderPositioning() {
            const header = document.querySelector('header.sticky-header');
            const navTabs = document.getElementById('navigationTabs');
            const mainContent = document.querySelector('.content-with-sticky-header');
            
            if (header && navTabs && mainContent) {
                const headerHeight = header.offsetHeight;
                const navTabsHeight = navTabs.offsetHeight;
                const totalHeight = headerHeight + navTabsHeight;
                
                console.log('Header height:', headerHeight);
                console.log('Nav tabs height:', navTabsHeight);
                console.log('Total height:', totalHeight);
                
                // Position nav tabs below the header
                navTabs.style.top = headerHeight + 'px';
                
                // Add margin to main content to account for both elements
                mainContent.style.marginTop = (totalHeight + 20) + 'px';
            }
        }
        
        // Initialize active tab styling and check auth
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                activeTab.classList.add('text-foreground', 'border-primary');
                activeTab.classList.remove('text-muted-foreground');
            }
            
            // Initialize provider preview
            updateProviderPreview();
            
            // Fix sticky header positioning
            adjustStickyHeaderPositioning();
            
            // Re-adjust on window resize
            window.addEventListener('resize', adjustStickyHeaderPositioning);
            
            // Setup notification hover functionality
            setupNotificationHover();
            
            // Check if user is already authenticated
            checkAuth();
        });
    </script>
</body>
</html>